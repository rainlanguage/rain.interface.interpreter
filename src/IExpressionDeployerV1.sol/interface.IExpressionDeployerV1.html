<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>IExpressionDeployerV1</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../../favicon.svg">
        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../../book.css">

    </head>
    <body>
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = null;
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item "><a href="../../index.html">Home</a></li><li class="chapter-item affix "><li class="part-title">src</li><li class="chapter-item "><a href="../../src/deployerDiscoverable/index.html">❱ deployerDiscoverable</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../src/deployerDiscoverable/DeployerDiscoverableMetaV1.sol/struct.DeployerDiscoverableMetaV1ConstructionConfig.html">DeployerDiscoverableMetaV1ConstructionConfig</a></li><li class="chapter-item "><a href="../../src/deployerDiscoverable/DeployerDiscoverableMetaV1.sol/abstract.DeployerDiscoverableMetaV1.html">DeployerDiscoverableMetaV1</a></li><li class="chapter-item "><a href="../../src/deployerDiscoverable/LibDeployerDiscoverable.sol/library.LibDeployerDiscoverable.html">LibDeployerDiscoverable</a></li></ol></li><li class="chapter-item "><a href="../../src/deprecated/index.html">❱ deprecated</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../src/deprecated/IInterpreterCallerV1.sol/struct.SignedContext.html">SignedContext</a></li><li class="chapter-item "><a href="../../src/deprecated/IInterpreterCallerV1.sol/interface.IInterpreterCallerV1.html">IInterpreterCallerV1</a></li><li class="chapter-item "><a href="../../src/deprecated/IInterpreterCallerV1.sol/constants.IInterpreterCallerV1.html">IInterpreterCallerV1 constants</a></li></ol></li><li class="chapter-item "><a href="../../src/unstable/index.html">❱ unstable</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../src/unstable/IDebugExpressionDeployerV1.sol/interface.IDebugExpressionDeployerV1.html">IDebugExpressionDeployerV1</a></li><li class="chapter-item "><a href="../../src/unstable/IDebugInterpreterV1.sol/interface.IDebugInterpreterV1.html">IDebugInterpreterV1</a></li></ol></li><li class="chapter-item expanded "><a href="../../src/IExpressionDeployerV1.sol/interface.IExpressionDeployerV1.html" class="active">IExpressionDeployerV1</a></li><li class="chapter-item "><a href="../../src/IInterpreterCallerV2.sol/struct.SignedContextV1.html">SignedContextV1</a></li><li class="chapter-item "><a href="../../src/IInterpreterCallerV2.sol/interface.IInterpreterCallerV2.html">IInterpreterCallerV2</a></li><li class="chapter-item "><a href="../../src/IInterpreterCallerV2.sol/constants.IInterpreterCallerV2.html">IInterpreterCallerV2 constants</a></li><li class="chapter-item "><a href="../../src/IInterpreterExternV1.sol/type.EncodedExternDispatch.html">EncodedExternDispatch</a></li><li class="chapter-item "><a href="../../src/IInterpreterExternV1.sol/type.ExternDispatch.html">ExternDispatch</a></li><li class="chapter-item "><a href="../../src/IInterpreterExternV1.sol/interface.IInterpreterExternV1.html">IInterpreterExternV1</a></li><li class="chapter-item "><a href="../../src/IInterpreterStoreV1.sol/type.FullyQualifiedNamespace.html">FullyQualifiedNamespace</a></li><li class="chapter-item "><a href="../../src/IInterpreterStoreV1.sol/interface.IInterpreterStoreV1.html">IInterpreterStoreV1</a></li><li class="chapter-item "><a href="../../src/IInterpreterStoreV1.sol/constants.IInterpreterStoreV1.html">IInterpreterStoreV1 constants</a></li><li class="chapter-item "><a href="../../src/IInterpreterV1.sol/type.SourceIndex.html">SourceIndex</a></li><li class="chapter-item "><a href="../../src/IInterpreterV1.sol/type.EncodedDispatch.html">EncodedDispatch</a></li><li class="chapter-item "><a href="../../src/IInterpreterV1.sol/type.StateNamespace.html">StateNamespace</a></li><li class="chapter-item "><a href="../../src/IInterpreterV1.sol/type.Operand.html">Operand</a></li><li class="chapter-item "><a href="../../src/IInterpreterV1.sol/interface.IInterpreterV1.html">IInterpreterV1</a></li><li class="chapter-item "><a href="../../src/IInterpreterV1.sol/constants.IInterpreterV1.html">IInterpreterV1 constants</a></li><li class="chapter-item "><a href="../../src/LibContext.sol/error.InvalidSignature.html">InvalidSignature</a></li><li class="chapter-item "><a href="../../src/LibContext.sol/library.LibContext.html">LibContext</a></li><li class="chapter-item "><a href="../../src/LibEncodedDispatch.sol/library.LibEncodedDispatch.html">LibEncodedDispatch</a></li><li class="chapter-item "><a href="../../src/LibEvaluable.sol/struct.EvaluableConfig.html">EvaluableConfig</a></li><li class="chapter-item "><a href="../../src/LibEvaluable.sol/struct.Evaluable.html">Evaluable</a></li><li class="chapter-item "><a href="../../src/LibEvaluable.sol/library.LibEvaluable.html">LibEvaluable</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title"></h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/rainprotocol/rain.interface.interpreter" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="iexpressiondeployerv1"><a class="header" href="#iexpressiondeployerv1">IExpressionDeployerV1</a></h1>
<p><a href="https://github.com/rainprotocol/rain.interface.interpreter/blob/c5802fe07df3e765aea68e65dc3e1ceffc86a305/src/IExpressionDeployerV1.sol">Git Source</a></p>
<p>Companion to <code>IInterpreterV1</code> responsible for onchain static code
analysis and deploying expressions. Each <code>IExpressionDeployerV1</code> is tightly
coupled at the bytecode level to some interpreter that it knows how to
analyse and deploy expressions for. The expression deployer can perform an
integrity check &quot;dry run&quot; of candidate source code for the intepreter. The
critical analysis/transformation includes:</p>
<ul>
<li>Enforcement of no out of bounds memory reads/writes</li>
<li>Calculation of memory required to eval the stack with a single allocation</li>
<li>Replacing index based opcodes with absolute interpreter function pointers</li>
<li>Enforcement that all opcodes and operands used exist and are valid
This analysis is highly sensitive to the specific implementation and position
of all opcodes and function pointers as compiled into the interpreter. This
is what makes the coupling between an interpreter and expression deployer
so tight. Ideally all responsibilities would be handled by a single contract
but this introduces code size issues quickly by roughly doubling the compiled
logic of each opcode (half for the integrity check and half for evaluation).
Interpreters MUST assume that expression deployers are malicious and fail
gracefully if the integrity check is corrupt/bypassed and/or function
pointers are incorrect, etc. i.e. the interpreter MUST always return a stack
from <code>eval</code> in a read only way or error. I.e. it is the expression deployer's
responsibility to do everything it can to prevent undefined behaviour in the
interpreter, and the interpreter's responsibility to handle the expression
deployer completely failing to do so.</li>
</ul>
<h2 id="functions"><a class="header" href="#functions">Functions</a></h2>
<h3 id="deployexpression"><a class="header" href="#deployexpression">deployExpression</a></h3>
<p>Expressions are expected to be deployed onchain as immutable contract
code with a first class address like any other contract or account.
Technically this is optional in the sense that all the tools required to
eval some expression and define all its opcodes are available as
libraries.
In practise there are enough advantages to deploying the sources directly
onchain as contract data and loading them from the interpreter at eval:</p>
<ul>
<li>Loading and storing binary data is gas efficient as immutable contract
data</li>
<li>Expressions need to be immutable between their deploy time integrity
check and runtime evaluation</li>
<li>Passing the address of an expression through calldata to an interpreter
is cheaper than passing an entire expression through calldata</li>
<li>Conceptually a very simple approach, even if implementations like
SSTORE2 are subtle under the hood
The expression deployer MUST perform an integrity check of the source
code before it puts the expression onchain at a known address. The
integrity check MUST at a minimum (it is free to do additional static
analysis) calculate the memory required to be allocated for the stack in
total, and that no out of bounds memory reads/writes occur within this
stack. A simple example of an invalid source would be one that pushes one
value to the stack then attempts to pops two values, clearly we cannot
remove more values than we added. The <code>IExpressionDeployerV1</code> MUST revert
in the case of any integrity failure, all integrity checks MUST pass in
order for the deployment to complete.
Once the integrity check is complete the <code>IExpressionDeployerV1</code> MUST do
any additional processing required by its paired interpreter.
For example, the <code>IExpressionDeployerV1</code> MAY NEED to replace the indexed
opcodes in the <code>ExpressionConfig</code> sources with real function pointers
from the corresponding interpreter.</li>
</ul>
<pre><code class="language-solidity">function deployExpression(bytes[] memory sources, uint256[] memory constants, uint256[] memory minOutputs)
    external
    returns (IInterpreterV1 interpreter, IInterpreterStoreV1 store, address expression);
</code></pre>
<p><strong>Parameters</strong></p>
<div class="table-wrapper"><table><thead><tr><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>sources</code></td><td><code>bytes[]</code></td><td>Sources verbatim. These sources MUST be provided in their sequential/index opcode form as the deployment process will need to index into BOTH the integrity check and the final runtime function pointers. This will be emitted in an event for offchain processing to use the indexed opcode sources. The first N sources are considered entrypoints and will be integrity checked by the expression deployer against a starting stack height of 0. Non-entrypoint sources MAY be provided for internal use such as the <code>call</code> opcode but will NOT be integrity checked UNLESS entered by an opcode in an entrypoint.</td></tr>
<tr><td><code>constants</code></td><td><code>uint256[]</code></td><td>Constants verbatim. Constants are provided alongside sources rather than inline as it allows us to avoid variable length opcodes and can be more memory efficient if the same constant is referenced several times from the sources.</td></tr>
<tr><td><code>minOutputs</code></td><td><code>uint256[]</code></td><td>The first N sources on the state config are entrypoints to the expression where N is the length of the <code>minOutputs</code> array. Each item in the <code>minOutputs</code> array specifies the number of outputs that MUST be present on the final stack for an evaluation of each entrypoint. The minimum output for some entrypoint MAY be zero if the expectation is that the expression only applies checks and error logic. Non-entrypoint sources MUST NOT have a minimum outputs length specified.</td></tr>
</tbody></table>
</div>
<p><strong>Returns</strong></p>
<div class="table-wrapper"><table><thead><tr><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>interpreter</code></td><td><code>IInterpreterV1</code></td><td>The interpreter the deployer believes it is qualified to perform integrity checks on behalf of.</td></tr>
<tr><td><code>store</code></td><td><code>IInterpreterStoreV1</code></td><td>The interpreter store the deployer believes is compatible with the interpreter.</td></tr>
<tr><td><code>expression</code></td><td><code>address</code></td><td>The address of the deployed onchain expression. MUST be valid according to all integrity checks the deployer is aware of.</td></tr>
</tbody></table>
</div>
<h2 id="events"><a class="header" href="#events">Events</a></h2>
<h3 id="dispair"><a class="header" href="#dispair">DISpair</a></h3>
<p>This is the literal InterpreterOpMeta bytes to be used offchain to make
sense of the opcodes in this interpreter deployment, as a human. For
formats like json that make heavy use of boilerplate, repetition and
whitespace, some kind of compression is recommended.</p>
<pre><code class="language-solidity">event DISpair(address sender, address deployer, address interpreter, address store, bytes opMeta);
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../src/unstable/IDebugInterpreterV1.sol/interface.IDebugInterpreterV1.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="../../src/IInterpreterCallerV2.sol/struct.SignedContextV1.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../src/unstable/IDebugInterpreterV1.sol/interface.IDebugInterpreterV1.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="../../src/IInterpreterCallerV2.sol/struct.SignedContextV1.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../../elasticlunr.min.js"></script>
        <script src="../../mark.min.js"></script>
        <script src="../../searcher.js"></script>

        <script src="../../clipboard.min.js"></script>
        <script src="../../highlight.js"></script>
        <script src="../../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../../solidity.min.js"></script>


    </div>
    </body>
</html>
